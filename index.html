<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç¢ºèªã‚¢ãƒ—ãƒª</title>
  <script src="https://unpkg.com/html5-qrcode"></script> <!-- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
</head>
<body>
  <h1>JANã‚³ãƒ¼ãƒ‰ã§ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åˆ¤å®š</h1>
  <input id="janInput" placeholder="JANã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã¾ãŸã¯ã‚¹ã‚­ãƒ£ãƒ³" oninput="onJanInput()" />
  <button onclick="startScanner()">ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³</button>
  <div id="scanner" style="width: 300px; height: 300px; margin-top: 10px;"></div>
  <div id="result"></div>

<script>
const productsData = [
  { "jan": "4954628461612", "name": "SBTM327", "price": 68200, "brand": "SEIKO" },
  { "jan": "4549526370915", "name": "DW-H5600-1A2JR", "price": 44000, "brand": "CASIO" },
  { "jan": "4974375472365", "name": "AS1060-54A", "price": 44000, "brand": "CITIZEN" }
];

let csvProductsData = [];

const campaignsData = [
  { id: "casio_warranty", name: "ã‚«ã‚·ã‚ªä¿è¨¼å»¶é•·", discount_rate: 0.05, reason: "ã‚«ã‚·ã‚ªè£½å“ï¼ˆä¸€éƒ¨é™¤ãï¼‰ã«é©ç”¨" },
  { id: "citizen_warranty", name: "ã‚·ãƒã‚ºãƒ³ä¿è¨¼å»¶é•·", discount_rate: 0.03, reason: "ã‚·ãƒã‚ºãƒ³è£½å“ï¼ˆä¸€éƒ¨é™¤ãï¼‰ã«é©ç”¨" },
  { id: "citizen_interest_free", name: "ã‚·ãƒã‚ºãƒ³åˆ†å‰²ç„¡é‡‘åˆ©", discount_rate: 0, reason: "ã‚·ãƒã‚ºãƒ³è£½å“ã«é©ç”¨" },
  { id: "freshers_discount", name: "ãƒ•ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚ºå‰²", discount_rate: 0.10, reason: "æ–°ç¤¾ä¼šäººãƒ»å­¦ç”Ÿã«é©ç”¨" },
  { id: "anniversary_70th", name: "70å‘¨å¹´ç‰¹æ‹›ä¼š", discount_rate: 0.15, reason: "33,000å††ä»¥ä¸Šã®å•†å“ã«é©ç”¨" }
];

function getCampaignApplicability(product) {
  const applicable = [];
  const nonApplicable = [];
  const gshockModels = ['GMC-B2100', 'GMW-B5000', 'GM-B2100'];

  if (product.brand === 'CASIO' &&
      (product.name.includes('ã‚¨ãƒ‡ã‚£ãƒ•ã‚£ã‚¹') ||
       (product.name.includes('G-SHOCK') && gshockModels.some(m => product.name.includes(m))) ||
       product.name.includes('ã‚ªã‚·ã‚¢ãƒŠã‚¹'))) {
    applicable.push({ campaign_id: 'casio_warranty' });
  } else {
    nonApplicable.push({ campaign_id: 'casio_warranty' });
  }

  const citizenSeries = ['ã‚¢ãƒ†ãƒƒã‚µ', 'xC', 'ã‚·ãƒã‚ºãƒ³ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³'];
  if (product.brand === 'CITIZEN' && citizenSeries.some(s => product.name.includes(s))) {
    applicable.push({ campaign_id: 'citizen_warranty' });
  } else {
    nonApplicable.push({ campaign_id: 'citizen_warranty' });
  }

  if (product.brand === 'CITIZEN') {
    applicable.push({ campaign_id: 'citizen_interest_free' });
  } else {
    nonApplicable.push({ campaign_id: 'citizen_interest_free' });
  }

  applicable.push({ campaign_id: 'freshers_discount' });

  if (product.price >= 33000) {
    applicable.push({ campaign_id: 'anniversary_70th' });
  } else {
    nonApplicable.push({ campaign_id: 'anniversary_70th' });
  }

  return { applicable, nonApplicable };
}

function calculateDiscount(price, campaign) {
  return price * campaign.discount_rate;
}

function onJanInput() {
  const jan = document.getElementById("janInput").value.trim();
  console.log("å…¥åŠ›ã•ã‚ŒãŸJANã‚³ãƒ¼ãƒ‰:", jan);

  let product = productsData.find(p => p.jan === jan);
  if (!product) {
    product = csvProductsData.find(p => p.jan === jan);
  }

  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";

  if (!product) {
    resultDiv.innerHTML = "<p>è©²å½“å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>";
    console.log("å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
    return;
  }

  const { applicable, nonApplicable } = getCampaignApplicability(product);

  const name = product.name;
  const brand = product.brand;
  const price = product.price;

  let html = `<h2>${brand}</h2><p>å•†å“å: ${name} / ãƒ–ãƒ©ãƒ³ãƒ‰: ${brand} / ç¨è¾¼ä¾¡æ ¼: Â¥${price.toLocaleString()}</p>`;

  html += "<h3>é©ç”¨ã•ã‚Œã‚‹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</h3><ul>";
  applicable.forEach(c => {
    const campaign = campaignsData.find(cd => cd.id === c.campaign_id);
    const discount = calculateDiscount(price, campaign);
    const discountedPrice = price - discount;
    html += `
      <li>
        ${campaign.name} (å‰²å¼•é¡: Â¥${discount.toLocaleString()}, 
        å‰²å¼•å¾Œä¾¡æ ¼: Â¥${discountedPrice.toLocaleString()}, 
        ç†ç”±: ${campaign.reason})
      </li>
    `;
  });
  html += "</ul>";

  html += "<h3>å¯¾è±¡å¤–ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</h3><ul>";
  nonApplicable.forEach(c => {
    const campaign = campaignsData.find(cd => cd.id === c.campaign_id);
    html += `<li>${campaign.name} (ç†ç”±: ${campaign.reason})</li>`;
  });
  html += "</ul>";

  resultDiv.innerHTML = html;
}

// ğŸ“¸ ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½
function startScanner() {
  const scanner = new Html5QrcodeScanner(
    "scanner",
    { fps: 10, qrbox: 250 },
    false
  );

  scanner.render(
    (decodedText) => {
      document.getElementById("janInput").value = decodedText;
      scanner.clear();
      document.getElementById("scanner").innerHTML = "";
      onJanInput();
    },
    (errorMessage) => {
      console.warn("ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:", errorMessage);
    }
  );
}

async function loadCsvData() {
  try {
    const response = await fetch('130.csv');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const csv = await response.text();
    parseCsvData(csv);
  } catch (error) {
    console.error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  }
}

function parseCsvData(csv) {
  csvProductsData = [];
  const lines = csv.split('\n');
  const headers = lines[0].split(',').map(header => header.trim());

  for (let i = 1; i < lines.length; i++) {
    const data = lines[i].split(',').map(data => data.trim());
    if (data.length === headers.length) {
      let product = {};
      for (let j = 0; j < headers.length; j++) {
        product[headers[j]] = data[j];
      }
      if (product["PLUã‚³ãƒ¼ãƒ‰"] && product["å•†å“åç§°"] && product["å£²ä¾¡"]) {
        csvProductsData.push({
          jan: product["PLUã‚³ãƒ¼ãƒ‰"],
          name: product["å•†å“åç§°"],
          price: parseFloat(product["å£²ä¾¡"]),
          brand: product["ãƒ¡ãƒ¼ã‚«ãƒ¼å"] || "ä¸æ˜"
        });
      }
    }
  }
  console.log("CSVãƒ‡ãƒ¼ã‚¿è§£æå®Œäº†:", csvProductsData);
}

window.onload = loadCsvData;
</script>
</body>
</html>
