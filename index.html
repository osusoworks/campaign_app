<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>キャンペーンスキャナー</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #result { margin-top: 20px; font-size: 1.5em; }
    #campaign-name { font-size: 2em; font-weight: bold; margin-bottom: 10px; }
    #operation { font-size: 1.2em; white-space: pre-wrap; }
    #reader { width: 100%; max-width: 500px; margin: auto; }
  </style>
</head>
<body>
  <h1>キャンペーンスキャナー</h1>
  <div id="reader"></div>
  <div id="result">
    <div id="campaign-name"></div>
    <div id="operation"></div>
  </div>

<script>
let campaigns = [];

// CSV読み込み
document.addEventListener("DOMContentLoaded", async () => {
  const response = await fetch("campaigns.csv");
  const csvText = await response.text();
  campaigns = parseCsv(csvText);

  // QRコードスキャナー初期化
  const html5QrCode = new Html5Qrcode("reader");
  const config = { fps: 10, qrbox: 250, experimentalFeatures: { useBarCodeDetectorIfSupported: true } };

  Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
      html5QrCode.start({ facingMode: { exact: "environment" } }, config, onScanSuccess);
    }
  });
});

function parseCsv(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",").map(h => h.trim());
  return lines.slice(1).map(line => {
    const values = line.split(",").map(v => v.trim());
    let obj = {};
    headers.forEach((h, i) => obj[h] = values[i]);
    return obj;
  });
}

function onScanSuccess(decodedText) {
  console.log("読み取ったJANコード:", decodedText);

  const match = campaigns.find(c => c.jan && c.jan === decodedText);

  if (match) {
    document.getElementById("campaign-name").innerText = match.name;
    document.getElementById("operation").innerText = match.operation;
  } else {
    document.getElementById("campaign-name").innerText = "対象キャンペーンなし";
    document.getElementById("operation").innerText = "";
  }
}
</script>

</body>
</html>
